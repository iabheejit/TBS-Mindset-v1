name: Azure Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# REQUIRED for azure/login
permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üì¶ Install
        run: npm install

      - name: üèóÔ∏è Build (optional)
        run: npm run build --if-present

      - name: Install prod deps
        run: npm ci --omit=dev

      - name: üîê Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure App Settings (idempotent)
        run: |
          az webapp config appsettings set -g TBS-rg_group -n TBS-rg --settings \
            NODE_ENV=production PORT=8080 TZ=Asia/Kolkata \
            PERSONAL_ACCESS_TOKEN='${{ secrets.PERSONAL_ACCESS_TOKEN }}' \
            BASE_ID='${{ secrets.BASE_ID }}' \
            TABLE_ID='${{ secrets.TABLE_ID }}' \
            CONTENT_TABLE_ID='${{ secrets.CONTENT_TABLE_ID }}' \
            API='${{ secrets.API }}' \
            WEBHOOK_URL='https://tbs-rg-gxfnddazdmcgbedm.centralindia-01.azurewebsites.net'

      - name: Enforce Health Check Path
        run: az webapp update -g TBS-rg_group -n TBS-rg --set siteConfig.healthCheckPath="/ping"

      - name: Disable remote build
        run: |
          az webapp config appsettings set \
            -g TBS-rg_group -n TBS-rg \
            --settings SCM_DO_BUILD_DURING_DEPLOYMENT=false

      - name: üöÄ Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: TBS-rg   # ensure this is the actual App Service name
          package: .
